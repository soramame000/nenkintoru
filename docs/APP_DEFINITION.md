# 年金トール君（nenkintoru）再定義

## 1. このアプリは何か

障害年金の申請で必要になる「病歴・就労状況等申立書」を、ユーザーの入力（選択式＋時系列）から客観的で読みやすい下書きに整形し、PDF/Excelで出力できるアプリ。

## 2. 誰のためか（ターゲット）

- うつ病 / 双極性障害で障害年金申請を検討している本人（または支援者）
- 文章作成が負担になりやすく、時系列整理・具体化が難しい人

## 3. 提供価値（Job-to-be-done）

- 申立書で重要な「時系列」と「具体性」を、迷いにくいUI（チェック/選択）で収集する
- 誇張せず事実ベースで、審査官に伝わりやすい文章構造に落とし込む
- 出力（PDF/Excel）までを一気通貫で行い、提出準備を短縮する

## 4. 非ゴール（やらないこと）

- 法律/審査結果の保証、個別の法的助言
- 医療診断や治療方針の提示
- ユーザーの入力内容をブラウザ永続ストレージ（localStorage等）に長期保存すること

## 5. 主要ユーザーフロー

1. 新規登録（Email/Password）
2. 購入（Stripe Checkout）
3. 5ステップ入力（基本情報 → 症状 → 病歴 → 就労 → 追加）
4. 生成結果の確認（必要なら再生成）
5. PDF/Excelでダウンロード
6. ダッシュボードで購入状況・生成履歴を確認

## 6. データと責務（ざっくり）

- `users`：メール/パスワード（ハッシュ）を保持
- `subscriptions`：購入により付与される利用権（期限・生成上限・利用状況）を保持
- `generations`：生成結果（文章）と生成時の入力（`input_data`）を保持

※ センシティブ情報の取り扱いは、最小化と用途の明確化を優先する（「なぜ保存するか」「いつ消すか」を運用で定義する）。

## 7. 権限/セキュリティ設計（方針）

- 認証：NextAuth（Credentials）でセッションを確立
- DBアクセス：サーバー側のみでSupabase Service Roleを使用（クライアントへキーは渡さない）
- レート制限：生成API・ログイン/登録をUpstashで抑制
- 生成回数：DBのRPCで原子的にカウントを確保し、並列実行で上限突破しない
- 決済：Stripe Webhook署名検証 + 冪等化（同一Checkout Sessionの重複登録防止）
- ブラウザ保存：途中入力・直近の生成結果は `sessionStorage` に限定（端末に残り続けない）

## 8. UXの原則（最低限）

- “迷わない入力” を最優先（選択肢中心、任意/必須の明確化）
- 入力変更後の結果の「古さ」を明示し、意図しない再生成（=回数消費）を避ける
- エラーは「次に何をすれば良いか」を一言で案内する

## 9. 実装の境界（現状の構成）

- Next.js App Router
- `app/api/*`：認証/決済/生成/ユーザー情報のAPI
- `hooks/*`：セッション・購読・生成入力の状態管理（sessionStorage）
- `lib/*`：Supabase/Stripe/OpenAI/バリデーション等の基盤
